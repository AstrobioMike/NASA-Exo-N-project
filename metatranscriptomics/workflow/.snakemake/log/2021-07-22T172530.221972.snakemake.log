Building DAG of jobs...
Using shell: /bin/bash
Provided cores: 8
Rules claiming more threads will be scaled down.
Job stats:
job                                                   count    min threads    max threads
--------------------------------------------------  -------  -------------  -------------
all                                                       1              1              1
combine_all_gene_coverages_collapsed_by_KO_and_tax        1              1              1
combine_group_gene_coverage_annots_and_tax                2              1              1
get_cov_and_det                                           1              1              1
run_tax_classification                                    2              1              1
total                                                     7              1              1

Select jobs to execute...

[Thu Jul 22 17:25:32 2021]
rule run_tax_classification:
    input: ../assemblies/T1_F2_N-coassembly.fa, ../predicted-genes/T1_F2_N-genes.faa, /home/mdlee4/ref-dbs/CAT_prepare_20210107/CAT_DB_SETUP
    output: ../annotations-and-taxonomy/T1_F2_N-gene-tax.tsv, ../annotations-and-taxonomy/T1_F2_N-transcript-tax.tsv
    log: logs/T1_F2_N-CAT.log
    jobid: 27
    wildcards: group=T1_F2_N
    resources: tmpdir=/tmp


        CAT contigs -d /home/mdlee4/ref-dbs/CAT_prepare_20210107/2021-01-07_CAT_database -t /home/mdlee4/ref-dbs/CAT_prepare_20210107/2021-01-07_taxonomy -n 10 -r 3 --top 4 --I_know_what_Im_doing -c ../assemblies/T1_F2_N-coassembly.fa -p ../predicted-genes/T1_F2_N-genes.faa -o ../annotations-and-taxonomy/T1_F2_N-tax-out.tmp --force > logs/T1_F2_N-CAT.log 2>&1

        # adding names to gene classifications
        CAT add_names -i ../annotations-and-taxonomy/T1_F2_N-tax-out.tmp.ORF2LCA.txt -o ../annotations-and-taxonomy/T1_F2_N-gene-tax.tmp -t /home/mdlee4/ref-dbs/CAT_prepare_20210107/2021-01-07_taxonomy --only_official > logs/T1_F2_N-CAT.log 2>&1

        # formatting gene classifications
        awk -F $'	' ' BEGIN { OFS=FS } { if ( $2 == "lineage" ) { print $1,$2,$4,$5,$6,$7,$8,$9,$10 }         else if ( $2 == "ORF has no hit to database" || $2 ~ /^no taxid found/ ) { print $1,"NA","NA","NA","NA","NA","NA","NA","NA" }         else { n=split($2,lineage,";"); print $1,lineage[n],$4,$5,$6,$7,$8,$9,$10 } } ' ../annotations-and-taxonomy/T1_F2_N-gene-tax.tmp |         sed 's/not classified/NA/g' | sed 's/superkingdom/domain/' | sed 's/^# ORF/gene_ID/' | sed 's/lineage/taxid/' |         sed 's/\*//g' > ../annotations-and-taxonomy/T1_F2_N-gene-tax.tsv

        # adding names to contig classifications
        CAT add_names -i ../annotations-and-taxonomy/T1_F2_N-tax-out.tmp.contig2classification.txt -o ../annotations-and-taxonomy/T1_F2_N-transcript-tax.tmp -t /home/mdlee4/ref-dbs/CAT_prepare_20210107/2021-01-07_taxonomy --only_official > logs/T1_F2_N-CAT.log 2>&1

        # formatting contig classifications
        awk -F $'	' ' BEGIN { OFS=FS } { if ( $2 == "classification" ) { print $1,$4,$6,$7,$8,$9,$10,$11,$12 }         else if ( $2 == "unclassified" ) { print $1,"NA","NA","NA","NA","NA","NA","NA","NA" }         else { n=split($4,lineage,";"); print $1,lineage[n],$6,$7,$8,$9,$10,$11,$12 } } ' ../annotations-and-taxonomy/T1_F2_N-transcript-tax.tmp |         sed 's/not classified/NA/g' | sed 's/superkingdom/domain/' | sed 's/: [0-9\.]*//g' | sed 's/^# contig/contig_ID/' |         sed 's/lineage/taxid/' | sed 's/\*//g' > ../annotations-and-taxonomy/T1_F2_N-transcript-tax.tsv

        rm -rf ../annotations-and-taxonomy/T1_F2_N-tax-out.tmp ../annotations-and-taxonomy/T1_F2_N-gene-tax.tmp ../annotations-and-taxonomy/T1_F2_N-transcript-tax.tmp
        
Activating conda environment: /home/mdlee4/miniconda3/envs/genelab-utils/envs/14691dd32061cca186a5c0190ff0e259

[Thu Jul 22 17:25:33 2021]
rule run_tax_classification:
    input: ../assemblies/T1_F1_P-coassembly.fa, ../predicted-genes/T1_F1_P-genes.faa, /home/mdlee4/ref-dbs/CAT_prepare_20210107/CAT_DB_SETUP
    output: ../annotations-and-taxonomy/T1_F1_P-gene-tax.tsv, ../annotations-and-taxonomy/T1_F1_P-transcript-tax.tsv
    log: logs/T1_F1_P-CAT.log
    jobid: 14
    wildcards: group=T1_F1_P
    resources: tmpdir=/tmp


        CAT contigs -d /home/mdlee4/ref-dbs/CAT_prepare_20210107/2021-01-07_CAT_database -t /home/mdlee4/ref-dbs/CAT_prepare_20210107/2021-01-07_taxonomy -n 10 -r 3 --top 4 --I_know_what_Im_doing -c ../assemblies/T1_F1_P-coassembly.fa -p ../predicted-genes/T1_F1_P-genes.faa -o ../annotations-and-taxonomy/T1_F1_P-tax-out.tmp --force > logs/T1_F1_P-CAT.log 2>&1

        # adding names to gene classifications
        CAT add_names -i ../annotations-and-taxonomy/T1_F1_P-tax-out.tmp.ORF2LCA.txt -o ../annotations-and-taxonomy/T1_F1_P-gene-tax.tmp -t /home/mdlee4/ref-dbs/CAT_prepare_20210107/2021-01-07_taxonomy --only_official > logs/T1_F1_P-CAT.log 2>&1

        # formatting gene classifications
        awk -F $'	' ' BEGIN { OFS=FS } { if ( $2 == "lineage" ) { print $1,$2,$4,$5,$6,$7,$8,$9,$10 }         else if ( $2 == "ORF has no hit to database" || $2 ~ /^no taxid found/ ) { print $1,"NA","NA","NA","NA","NA","NA","NA","NA" }         else { n=split($2,lineage,";"); print $1,lineage[n],$4,$5,$6,$7,$8,$9,$10 } } ' ../annotations-and-taxonomy/T1_F1_P-gene-tax.tmp |         sed 's/not classified/NA/g' | sed 's/superkingdom/domain/' | sed 's/^# ORF/gene_ID/' | sed 's/lineage/taxid/' |         sed 's/\*//g' > ../annotations-and-taxonomy/T1_F1_P-gene-tax.tsv

        # adding names to contig classifications
        CAT add_names -i ../annotations-and-taxonomy/T1_F1_P-tax-out.tmp.contig2classification.txt -o ../annotations-and-taxonomy/T1_F1_P-transcript-tax.tmp -t /home/mdlee4/ref-dbs/CAT_prepare_20210107/2021-01-07_taxonomy --only_official > logs/T1_F1_P-CAT.log 2>&1

        # formatting contig classifications
        awk -F $'	' ' BEGIN { OFS=FS } { if ( $2 == "classification" ) { print $1,$4,$6,$7,$8,$9,$10,$11,$12 }         else if ( $2 == "unclassified" ) { print $1,"NA","NA","NA","NA","NA","NA","NA","NA" }         else { n=split($4,lineage,";"); print $1,lineage[n],$6,$7,$8,$9,$10,$11,$12 } } ' ../annotations-and-taxonomy/T1_F1_P-transcript-tax.tmp |         sed 's/not classified/NA/g' | sed 's/superkingdom/domain/' | sed 's/: [0-9\.]*//g' | sed 's/^# contig/contig_ID/' |         sed 's/lineage/taxid/' | sed 's/\*//g' > ../annotations-and-taxonomy/T1_F1_P-transcript-tax.tsv

        rm -rf ../annotations-and-taxonomy/T1_F1_P-tax-out.tmp ../annotations-and-taxonomy/T1_F1_P-gene-tax.tmp ../annotations-and-taxonomy/T1_F1_P-transcript-tax.tmp
        
Activating conda environment: /home/mdlee4/miniconda3/envs/genelab-utils/envs/14691dd32061cca186a5c0190ff0e259

[Thu Jul 22 17:25:34 2021]
rule get_cov_and_det:
    input: ../read-mapping/R6-T1_F2_N.bam, ../predicted-genes/T1_F2_N-genes.fa
    output: ../read-mapping/R6-T1_F2_N-gene-coverages.tsv, ../read-mapping/R6-T1_F2_N-transcript-coverages.tsv
    log: logs/R6-T1_F2_N-pileup.log
    jobid: 24
    wildcards: ID=R6, group=T1_F2_N
    resources: tmpdir=/tmp


        pileup.sh -in ../read-mapping/R6-T1_F2_N.bam fastaorf=../predicted-genes/T1_F2_N-genes.fa outorf=../read-mapping/R6-T1_F2_N-gene-cov-and-det.tmp out=../read-mapping/R6-T1_F2_N-transcript-cov-and-det.tmp > logs/R6-T1_F2_N-pileup.log 2>&1

        # filtering coverages based on detection
          # genes
        grep -v "#" ../read-mapping/R6-T1_F2_N-gene-cov-and-det.tmp | awk -F $'	' ' BEGIN {OFS=FS} { if ( $10 <= 0.5 ) $4 = 0 } { print $1,$4 } ' > ../read-mapping/R6-T1_F2_N-gene-cov.tmp
        cat <( printf "gene_ID	coverage
" ) ../read-mapping/R6-T1_F2_N-gene-cov.tmp > ../read-mapping/R6-T1_F2_N-gene-coverages.tsv

          # transcripts
        grep -v "#" ../read-mapping/R6-T1_F2_N-transcript-cov-and-det.tmp | awk -F $'	' ' BEGIN {OFS=FS} { if ( $5 <= 50 ) $2 = 0 } { print $1,$2 } ' > ../read-mapping/R6-T1_F2_N-transcript-cov.tmp
        cat <( printf "transcript_ID	coverage
" ) ../read-mapping/R6-T1_F2_N-transcript-cov.tmp > ../read-mapping/R6-T1_F2_N-transcript-coverages.tsv

          # removing intermediate files
        rm ../read-mapping/R6-T1_F2_N-gene-cov-and-det.tmp ../read-mapping/R6-T1_F2_N-transcript-cov-and-det.tmp ../read-mapping/R6-T1_F2_N-gene-cov.tmp ../read-mapping/R6-T1_F2_N-transcript-cov.tmp
        
Activating conda environment: /home/mdlee4/miniconda3/envs/genelab-utils/envs/5a309e94df300f382f6d4207f7f0a57c
[Thu Jul 22 17:25:35 2021]
Finished job 24.
1 of 7 steps (14%) done
[Thu Jul 22 17:54:35 2021]
Finished job 14.
2 of 7 steps (29%) done
Select jobs to execute...

[Thu Jul 22 17:54:35 2021]
rule combine_group_gene_coverage_annots_and_tax:
    input: ../read-mapping/R1-T1_F1_P-gene-coverages.tsv, ../read-mapping/R2-T1_F1_P-gene-coverages.tsv, ../annotations-and-taxonomy/T1_F1_P-annotations.tsv, ../annotations-and-taxonomy/T1_F1_P-gene-tax.tsv
    output: ../combined-outputs/T1_F1_P-gene-coverages-annotations-and-tax.tsv, ../combined-outputs/T1_F1_P-CPM-normalized-gene-coverages-annotations-and-tax.tsv
    jobid: 2
    wildcards: group=T1_F1_P
    resources: tmpdir=/tmp


        python scripts/combine-gene-level-coverages-annots-and-tax-per-group.py -g T1_F1_P -a ../annotations-and-taxonomy/T1_F1_P-annotations.tsv -t ../annotations-and-taxonomy/T1_F1_P-gene-tax.tsv -o ../combined-outputs/ ../read-mapping/R1-T1_F1_P-gene-coverages.tsv ../read-mapping/R2-T1_F1_P-gene-coverages.tsv
        
[Thu Jul 22 17:54:37 2021]
Finished job 2.
3 of 7 steps (43%) done
[Thu Jul 22 18:06:33 2021]
Finished job 27.
4 of 7 steps (57%) done
Select jobs to execute...

[Thu Jul 22 18:06:33 2021]
rule combine_group_gene_coverage_annots_and_tax:
    input: ../read-mapping/R5-T1_F2_N-gene-coverages.tsv, ../read-mapping/R6-T1_F2_N-gene-coverages.tsv, ../annotations-and-taxonomy/T1_F2_N-annotations.tsv, ../annotations-and-taxonomy/T1_F2_N-gene-tax.tsv
    output: ../combined-outputs/T1_F2_N-gene-coverages-annotations-and-tax.tsv, ../combined-outputs/T1_F2_N-CPM-normalized-gene-coverages-annotations-and-tax.tsv
    jobid: 16
    wildcards: group=T1_F2_N
    resources: tmpdir=/tmp


        python scripts/combine-gene-level-coverages-annots-and-tax-per-group.py -g T1_F2_N -a ../annotations-and-taxonomy/T1_F2_N-annotations.tsv -t ../annotations-and-taxonomy/T1_F2_N-gene-tax.tsv -o ../combined-outputs/ ../read-mapping/R5-T1_F2_N-gene-coverages.tsv ../read-mapping/R6-T1_F2_N-gene-coverages.tsv
        
[Thu Jul 22 18:06:34 2021]
Finished job 16.
5 of 7 steps (71%) done
Select jobs to execute...

[Thu Jul 22 18:06:34 2021]
rule combine_all_gene_coverages_collapsed_by_KO_and_tax:
    input: ../combined-outputs/T1_F1_P-gene-coverages-annotations-and-tax.tsv, ../combined-outputs/T1_F2_N-gene-coverages-annotations-and-tax.tsv
    output: ../combined-outputs/All-combined-KO-function-coverages.tsv, ../combined-outputs/All-combined-KO-function-CPM-normalized-coverages.tsv, ../combined-outputs/All-combined-taxonomy-coverages.tsv, ../combined-outputs/All-combined-taxonomy-CPM-normalized-coverages.tsv
    jobid: 1
    resources: tmpdir=/tmp


        python scripts/combine-all-gene-tables.py -o ../combined-outputs/ ../combined-outputs/T1_F1_P-gene-coverages-annotations-and-tax.tsv ../combined-outputs/T1_F2_N-gene-coverages-annotations-and-tax.tsv
        
[Thu Jul 22 18:06:36 2021]
Error in rule combine_all_gene_coverages_collapsed_by_KO_and_tax:
    jobid: 1
    output: ../combined-outputs/All-combined-KO-function-coverages.tsv, ../combined-outputs/All-combined-KO-function-CPM-normalized-coverages.tsv, ../combined-outputs/All-combined-taxonomy-coverages.tsv, ../combined-outputs/All-combined-taxonomy-CPM-normalized-coverages.tsv
    shell:
        
        python scripts/combine-all-gene-tables.py -o ../combined-outputs/ ../combined-outputs/T1_F1_P-gene-coverages-annotations-and-tax.tsv ../combined-outputs/T1_F2_N-gene-coverages-annotations-and-tax.tsv
        
        (one of the commands exited with non-zero exit code; note that snakemake uses bash strict mode!)

Shutting down, this might take some time.
Exiting because a job execution failed. Look above for error message
Complete log: /mnt/data/Bebout_lab/N-project-metatranscriptomes/sandbox/workflow/.snakemake/log/2021-07-22T172530.221972.snakemake.log
